<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ë²ˆì—­ ê¸°ë¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .recording {
            animation: pulse 1.5s infinite;
        }
        .disabled-btn {
            background-color: #6b7280 !important;
            cursor: not-allowed !important;
        }
        .disabled-btn:hover {
            background-color: #6b7280 !important;
        }
        .status-blinking {
            animation: blink 2s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2px;
            background-color: #374151;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }
        .result-text {
            flex: 1;
            padding: 2px 4px;
        }
        .copy-btn {
            background-color: #4b5563;
            color: #d1d5db;
            border: none;
            padding: 2px 8px;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 12px;
            margin: 0 4px;
            transition: background-color 0.2s;
        }
        .copy-btn:hover {
            background-color: #6b7280;
        }
        .copy-btn:active {
            background-color: #374151;
        }
        .popup-btn {
            position: absolute;
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: all 0.2s;
            display: none;
        }
        .popup-btn:hover {
            background-color: #2563eb;
            transform: scale(1.05);
        }
        .popup-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 font-mono">
    <div class="max-w-4xl mx-auto">
        <header class="relative text-center mb-8">
            <h1 class="text-3xl font-bold text-white">ê°„ë‹¨í•œ ì˜ì–´ ìŒì„± ì¸ì‹ê¸°</h1>
            <p class="text-gray-400 mt-2">ì˜ì–´ë¡œ ë§í•˜ë©´ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.</p>
            
            <!-- ì„¤ì • ë²„íŠ¼ -->
            <div class="absolute top-0 right-0">
                <button id="settingsBtn" class="bg-gray-700 hover:bg-gray-600 text-white p-1 rounded-lg transition duration-300">
                    <span class="text-lg m-1">âš™ï¸</span>
                </button>
                
                <!-- ë“œë¡­ë‹¤ìš´ ë©”ë‰´ -->
                <div id="settingsDropdown" class="hidden absolute top-full right-0 mt-2 w-96 bg-gray-800 rounded-lg shadow-xl border border-gray-600 z-50">
                    <!-- API í‚¤ ì„¤ì • ì„¹ì…˜ -->
                    <div class="p-4 border-b border-gray-700">
                        <h3 class="text-white font-semibold mb-3 flex items-center gap-2">
                            <span>ğŸ”‘</span>
                            <span>API í‚¤ ì„¤ì •</span>
                            <span id="dropdownApiStatus" class="text-sm text-gray-400">ë¯¸ì„¤ì •</span>
                        </h3>
                        <div class="space-y-3">
                            <div class="flex gap-2">
                                <input type="password" id="dropdownApiKey" class="flex-1 bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="DeepL API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                                <button id="dropdownSaveKeyBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 text-sm whitespace-nowrap">
                                    ì €ì¥
                                </button>
                            </div>
                            <div class="text-xs text-gray-400 text-left">
                                â€» DeepL API í‚¤ê°€ ì„¤ì •ë˜ì–´ì•¼ ë²ˆì—­ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>
                    
                    <!-- ë””ë²„ê·¸ ì •ë³´ ì„¹ì…˜ -->
                    <div class="p-4">
                        <h3 class="text-white font-semibold mb-3 flex items-center gap-2">
                            <span>ğŸ”Š</span>
                            <span>ìŒì„± ì¸ì‹ ì„¤ì •</span>
                            <span id="dropdownDebugInfoStatus" class="text-sm text-gray-400">ë¯¸ì„¤ì •</span>
                        </h3>
                        <div id="dropdownDebugInfo" class="text-sm text-gray-300 text-left">
                            ë¸Œë¼ìš°ì € ì§€ì› ìƒíƒœë¥¼ í™•ì¸ ì¤‘...
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ -->
        <div class="flex justify-center gap-4 mb-6" style="line-height: 15px;">
            <button id="startBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                Start
            </button>
            <button id="stopBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300" disabled>
                Stop
            </button>
            <button id="clearBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                Reset
            </button>
        </div>


        <!-- ìƒíƒœ í‘œì‹œ -->
        <div id="status" class="text-center text-sm mb-6">
            ëŒ€ê¸° ì¤‘...
        </div>

        <!-- ì¸ì‹ëœ í…ìŠ¤íŠ¸ í‘œì‹œ ì˜ì—­ -->
        <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-white">ì¸ì‹ëœ í…ìŠ¤íŠ¸</h2>
            
            <!-- í˜„ì¬ ì¸ì‹ ì¤‘ì¸ í…ìŠ¤íŠ¸ -->
            <div id="interimResults" class="text-gray-400 italic mb-4 min-h-8">
                <!-- í˜„ì¬ ì¸ì‹ ì¤‘ì¸ ì„ì‹œ í…ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            
            <!-- ìµœì¢… ê²°ê³¼ (ìŠ¤í¬ë¡¤ ì˜ì—­) -->
            <div id="finalResults" class="space-y-2 border-t border-gray-600 pt-4 overflow-y-auto" style="height: 600px;">
                <!-- ìµœì¢… ì¸ì‹ ê²°ê³¼ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ë“œë˜ê·¸ íŒì—… ë²„íŠ¼ -->
        <button id="popupBtn" class="popup-btn">ë²ˆì—­í•˜ê¸°</button>


        <!-- ì„ íƒëœ í…ìŠ¤íŠ¸ í‘œì‹œ ì˜ì—­ -->
        <div id="selectedTextArea" class="mt-4 bg-gray-800 rounded-lg p-4 hidden">
            <h3 class="text-lg font-semibold mb-2 text-white">ì„ íƒëœ í…ìŠ¤íŠ¸</h3>
            <div class="result-item mb-4 border-l-4 rounded">
                <div id="selectedTextContent" class="p-2">
                    <!-- ì„ íƒëœ í…ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                <button id="copySelectedBtn" class="copy-btn">ë³µì‚¬</button>
            </div>
            
            <!-- ë²ˆì—­ ê²°ê³¼ ì˜ì—­ -->
            <div id="translationResultArea" class="hidden">
                <h4 class="text-md font-semibold mb-2 text-white">
                    ë²ˆì—­ ê²°ê³¼
                    <span id="translationStatus" class="text-sm font-normal text-gray-400 ml-2">
                        <!-- ë²ˆì—­ ìƒíƒœ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </span>
                </h4>
                <div id="translationResult" class="text-sm text-gray-300 p-3 bg-gray-700 rounded border-l-4 border-green-500">
                    <!-- ë²ˆì—­ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM ìš”ì†Œ ì°¸ì¡°
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const clearBtn = document.getElementById('clearBtn');
            const status = document.getElementById('status');
            const finalResults = document.getElementById('finalResults');
            const interimResults = document.getElementById('interimResults');
            const popupBtn = document.getElementById('popupBtn');
            const selectedTextArea = document.getElementById('selectedTextArea');
            const selectedTextContent = document.getElementById('selectedTextContent');
            const copySelectedBtn = document.getElementById('copySelectedBtn');
            const translationResultArea = document.getElementById('translationResultArea');
            const translationResult = document.getElementById('translationResult');
            const translationStatus = document.getElementById('translationStatus');
            
            // ì„¤ì • ë“œë¡­ë‹¤ìš´ ìš”ì†Œë“¤
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsDropdown = document.getElementById('settingsDropdown');
            const dropdownApiKey = document.getElementById('dropdownApiKey');
            const dropdownSaveKeyBtn = document.getElementById('dropdownSaveKeyBtn');
            const dropdownApiStatus = document.getElementById('dropdownApiStatus');
            const dropdownDebugInfo = document.getElementById('dropdownDebugInfo');
            const dropdownDebugInfoStatus = document.getElementById('dropdownDebugInfoStatus');

            let recognition = null;
            let isRecognizing = false;
            let lastFinalText = ''; // ë§ˆì§€ë§‰ìœ¼ë¡œ ì¶”ê°€ëœ ìµœì¢… í…ìŠ¤íŠ¸
            let selectedText = ''; // ì„ íƒëœ í…ìŠ¤íŠ¸ ì €ì¥
            let deepLApiKey = localStorage.getItem('deepLApiKey'); // API í‚¤ ì €ì¥

            // Web Speech API ì§€ì› í™•ì¸
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                dropdownDebugInfo.textContent = 'ìŒì„± ì¸ì‹ì´ ì§€ì›ë©ë‹ˆë‹¤.';
                dropdownDebugInfoStatus.textContent = 'ì„¤ì •ë¨';
                dropdownDebugInfoStatus.className = 'text-sm text-green-400';
            } else if ('SpeechRecognition' in window) {
                recognition = new SpeechRecognition();
                dropdownDebugInfo.textContent = 'ìŒì„± ì¸ì‹ì´ ì§€ì›ë©ë‹ˆë‹¤.';
                dropdownDebugInfoStatus.textContent = 'ì„¤ì •ë¨';
                dropdownDebugInfoStatus.className = 'text-sm text-green-400';
            } else {
                dropdownDebugInfo.textContent = 'âŒ ìŒì„± ì¸ì‹ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                dropdownDebugInfoStatus.textContent = 'ë¯¸ì„¤ì •';
                dropdownDebugInfoStatus.className = 'text-sm text-gray-400';
                startBtn.disabled = true;
                status.textContent = 'ë¸Œë¼ìš°ì €ê°€ ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                return;
            }

            // ìŒì„± ì¸ì‹ ì„¤ì •
            recognition.continuous = true;        // ì—°ì† ì¸ì‹
            recognition.interimResults = true;    // ì¤‘ê°„ ê²°ê³¼ í‘œì‹œ
            recognition.lang = 'en-US';          // ì˜ì–´ ì¸ì‹

            console.log('Speech recognition initialized with settings:');
            console.log('- continuous:', recognition.continuous);
            console.log('- interimResults:', recognition.interimResults);
            console.log('- lang:', recognition.lang);

            // ì‹œì‘ ë²„íŠ¼
            startBtn.addEventListener('click', () => {
                try {
                    recognition.start();
                    // ì¦‰ì‹œ ë²„íŠ¼ ë¹„í™œì„±í™” ë° ìŠ¤íƒ€ì¼ ë³€ê²½
                    startBtn.disabled = true;
                    startBtn.classList.add('disabled-btn');
                } catch (error) {
                    console.error('Failed to start recognition:', error);
                    status.textContent = 'ìŒì„± ì¸ì‹ ì‹œì‘ ì‹¤íŒ¨: ' + error.message;
                    // ì‹¤íŒ¨ì‹œ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                    startBtn.disabled = false;
                    startBtn.classList.remove('disabled-btn');
                }
            });

            // ì¤‘ì§€ ë²„íŠ¼
            stopBtn.addEventListener('click', () => {
                try {
                    recognition.stop();
                    // ì¦‰ì‹œ ë²„íŠ¼ ë¹„í™œì„±í™” ë° ìŠ¤íƒ€ì¼ ë³€ê²½
                    stopBtn.disabled = true;
                    stopBtn.classList.add('disabled-btn');
                } catch (error) {
                    console.error('Failed to stop recognition:', error);
                    // ì‹¤íŒ¨ì‹œ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                    stopBtn.disabled = false;
                    stopBtn.classList.remove('disabled-btn');
                }
            });

            // ì´ˆê¸°í™” ë²„íŠ¼
            clearBtn.addEventListener('click', () => {
                console.log('Clear button clicked');
                finalResults.innerHTML = '';
                interimResults.textContent = '';
                lastFinalText = ''; // ë§ˆì§€ë§‰ í…ìŠ¤íŠ¸ë„ ì´ˆê¸°í™”
                hidePopupBtn(); // íŒì—… ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                selectedTextArea.classList.add('hidden'); // ì„ íƒëœ í…ìŠ¤íŠ¸ ì˜ì—­ ìˆ¨ê¸°ê¸°
                translationResultArea.classList.add('hidden'); // ë²ˆì—­ ê²°ê³¼ ì˜ì—­ ìˆ¨ê¸°ê¸°
                status.textContent = 'ì´ˆê¸°í™” ì™„ë£Œ';
            });

            // API í‚¤ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateApiKeyStatus() {
                if (deepLApiKey) {
                    dropdownApiStatus.textContent = 'ì„¤ì •ë¨';
                    dropdownApiStatus.className = 'text-sm text-green-400';
                } else {
                    dropdownApiStatus.textContent = 'ë¯¸ì„¤ì •';
                    dropdownApiStatus.className = 'text-sm text-gray-400';
                }
            }

            // ë²ˆì—­ ê²°ê³¼ ì˜ì—­ ìƒíƒœ ì„¤ì • í•¨ìˆ˜
            function setTranslationResultStatus(status) {
                // ê¸°ì¡´ border í´ë˜ìŠ¤ ì œê±°
                translationResult.className = translationResult.className.replace(/border-l-4 border-\w+-\d+/g, '');
                
                if (status === 'success') {
                    // ì„±ê³µ: ì´ˆë¡ìƒ‰ í…Œë‘ë¦¬
                    translationResult.className += ' border-l-4 border-green-500';
                } else if (status === 'error') {
                    // ì˜¤ë¥˜: ë¹¨ê°„ìƒ‰ í…Œë‘ë¦¬
                    translationResult.className += ' border-l-4 border-red-500';
                } else if (status === 'loading') {
                    // ë¡œë”©: íŒŒë€ìƒ‰ í…Œë‘ë¦¬
                    translationResult.className += ' border-l-4 border-blue-500';
                }
            }

            // ë²ˆì—­ ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™” í•¨ìˆ˜
            function initializeTranslationResult() {
                translationResult.textContent = '';
                translationStatus.textContent = '';
                setTranslationResultStatus('loading');
            }

            // API í‚¤ ê´€ë¦¬
            if (deepLApiKey) {
                dropdownApiKey.value = deepLApiKey;
            }
            updateApiKeyStatus();

            // ì„¤ì • ë“œë¡­ë‹¤ìš´ í† ê¸€ ê¸°ëŠ¥
            settingsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isHidden = settingsDropdown.classList.contains('hidden');
                
                if (isHidden) {
                    settingsDropdown.classList.remove('hidden');
                } else {
                    settingsDropdown.classList.add('hidden');
                }
            });

            // ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            document.addEventListener('click', (e) => {
                if (!settingsDropdown.contains(e.target) && !settingsBtn.contains(e.target)) {
                    settingsDropdown.classList.add('hidden');
                }
            });

            // ë“œë¡­ë‹¤ìš´ ë‚´ë¶€ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ë‹¨
            settingsDropdown.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // API í‚¤ ì €ì¥ ê¸°ëŠ¥
            dropdownSaveKeyBtn.addEventListener('click', () => {
                const key = dropdownApiKey.value.trim();
                if (key) {
                    localStorage.setItem('deepLApiKey', key);
                    deepLApiKey = key;
                    updateApiKeyStatus();
                    status.textContent = 'DeepL API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
                } else {
                    status.textContent = 'API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                }
            });

            // ì„ íƒëœ í…ìŠ¤íŠ¸ ë³µì‚¬ ë²„íŠ¼
            copySelectedBtn.addEventListener('click', () => {
                const text = selectedTextContent.textContent;
                if (text) {
                    navigator.clipboard.writeText(text).then(() => {
                        copySelectedBtn.textContent = 'ì™„ë£Œ!';
                        setTimeout(() => {
                            copySelectedBtn.textContent = 'ë³µì‚¬';
                        }, 1000);
                    }).catch(err => {
                        console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                        copySelectedBtn.textContent = 'ì‹¤íŒ¨';
                        setTimeout(() => {
                            copySelectedBtn.textContent = 'ë³µì‚¬';
                        }, 1000);
                    });
                }
            });

            // íŒì—… ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            function hidePopupBtn() {
                popupBtn.style.display = 'none';
                selectedText = '';
            }

            // íŒì—… ë²„íŠ¼ í‘œì‹œ (í˜ì´ì§€ ê¸°ì¤€ ë§ˆìš°ìŠ¤ ìœ„ì¹˜)
            function showPopupBtn(pageX, pageY, text) {
                selectedText = text;
                popupBtn.style.display = 'block';
                popupBtn.style.left = pageX + 'px';
                popupBtn.style.top = (pageY - 50) + 'px'; // ë§ˆìš°ìŠ¤ ìœ„ë¡œ 50px
            }

            // ì„ íƒëœ í…ìŠ¤íŠ¸ í‘œì‹œ ë° ë²ˆì—­
            async function displaySelectedText(text) {
                selectedTextContent.textContent = text;
                selectedTextArea.classList.remove('hidden');
                
                // ë²ˆì—­ ì‹œì‘
                if (deepLApiKey) {
                    // ë²ˆì—­ ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™” ë° í‘œì‹œ
                    translationResultArea.classList.remove('hidden');
                    initializeTranslationResult();
                    translationStatus.textContent = 'ë²ˆì—­ ì¤‘...';
                    
                    const translatedText = await translateWithDeepL(text);
                    
                    if (translatedText) {
                        translationResult.textContent = translatedText;
                        setTranslationResultStatus('success');
                        translationStatus.textContent = 'ì™„ë£Œ';
                        
                        // 2ì´ˆ í›„ ìƒíƒœ ë©”ì‹œì§€ ì œê±°
                        setTimeout(() => {
                            translationStatus.textContent = '';
                        }, 2000);
                    } else {
                        translationStatus.textContent = '';
                        // ë²ˆì—­ ì‹¤íŒ¨ ë©”ì‹œì§€ì™€ ì˜¤ë¥˜ í…Œë‘ë¦¬ëŠ” translateWithDeepL í•¨ìˆ˜ì—ì„œ ì„¤ì •
                    }
                } else {
                    translationResultArea.classList.remove('hidden');
                    translationResult.textContent = '[ì˜¤ë¥˜] DeepL API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.';
                    setTranslationResultStatus('error');
                }
            }

            // DeepL API ë²ˆì—­ í•¨ìˆ˜
            async function translateWithDeepL(text) {
                if (!deepLApiKey) {
                    console.error('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    translationResult.textContent = '[ì˜¤ë¥˜] API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                    setTranslationResultStatus('error');
                    return null;
                }

                try {
                    const response = await fetch('https://api-free.deepl.com/v2/translate', {
                        method: 'POST',
                        headers: {
                            'Authorization': `DeepL-Auth-Key ${deepLApiKey}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            text: [text],
                            target_lang: 'KO'
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        const errorMessage = `[ë²ˆì—­ ì˜¤ë¥˜] ${response.status} - ${errorData.message || 'API í˜¸ì¶œ ì‹¤íŒ¨'}`;
                        translationResult.textContent = errorMessage;
                        setTranslationResultStatus('error');
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    console.log('ë²ˆì—­ ì‘ë‹µ:', data);
                    
                    if (data.translations && data.translations.length > 0) {
                        return data.translations[0].text;
                    } else {
                        const errorMessage = '[ë²ˆì—­ ì˜¤ë¥˜] ë²ˆì—­ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
                        translationResult.textContent = errorMessage;
                        setTranslationResultStatus('error');
                        throw new Error(errorMessage);
                    }
                } catch (error) {
                    console.error('ë²ˆì—­ ì˜¤ë¥˜:', error);
                    if (!translationResult.textContent.startsWith('[')) {
                        // ì•„ì§ ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì„¤ì •
                        translationResult.textContent = `[ë²ˆì—­ ì˜¤ë¥˜] ${error.message}`;
                        setTranslationResultStatus('error');
                    }
                    return null;
                }
            }

            // ë³µì‚¬ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì œê±°
            function cleanSelectedText(text) {
                return text
                    .replace(/ë³µì‚¬/g, '')
                    .replace(/ì™„ë£Œ!/g, '')
                    .replace(/ì‹¤íŒ¨/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();
            }

            // finalResults ì˜ì—­ì—ì„œë§Œ ë“œë˜ê·¸ ê°ì§€
            finalResults.addEventListener('mouseup', (event) => {
                const selection = window.getSelection();
                const selectionText = selection.toString().trim();
                
                if (selectionText && selectionText.length > 3) {
                    const cleanedText = cleanSelectedText(selectionText);
                    
                    if (cleanedText && cleanedText.length > 3) {
                        // í˜ì´ì§€ ê¸°ì¤€ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì— íŒì—… ë²„íŠ¼ í‘œì‹œ
                        showPopupBtn(event.pageX, event.pageY, cleanedText);
                        console.log('ì„ íƒëœ í…ìŠ¤íŠ¸:', cleanedText);
                    }
                }
            });

            // finalResults ì˜ì—­ ì™¸ë¶€ í´ë¦­ì‹œ íŒì—… ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            document.addEventListener('click', (event) => {
                if (!finalResults.contains(event.target) && event.target !== popupBtn) {
                    hidePopupBtn();
                    window.getSelection().removeAllRanges();
                }
            });

            // íŒì—… ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            popupBtn.addEventListener('click', () => {
                if (selectedText) {
                    displaySelectedText(selectedText);
                    hidePopupBtn();
                    window.getSelection().removeAllRanges();
                    console.log('ë²ˆì—­í•˜ê¸° ë²„íŠ¼ í´ë¦­ë¨:', selectedText);
                }
            });

            // ìŒì„± ì¸ì‹ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤
            recognition.onstart = () => {
                isRecognizing = true;
                status.textContent = 'ğŸ¤ ìŒì„± ì¸ì‹ ì¤‘... ì˜ì–´ë¡œ ë§ì”€í•˜ì„¸ìš”';
                status.classList.add('recording');
                status.classList.add('status-blinking'); // ê¹œë¹¡ê±°ë¦¬ëŠ” ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
                
                // Start ë²„íŠ¼ ë¹„í™œì„±í™” (ì´ë¯¸ í´ë¦­ ì‹œ ì²˜ë¦¬ë¨)
                startBtn.disabled = true;
                startBtn.classList.add('disabled-btn');
                
                // Stop ë²„íŠ¼ í™œì„±í™”
                stopBtn.disabled = false;
                stopBtn.classList.remove('disabled-btn');
            };

            recognition.onend = () => {
                isRecognizing = false;
                status.textContent = 'ëŒ€ê¸° ì¤‘...';
                status.classList.remove('recording');
                status.classList.remove('status-blinking'); // ê¹œë¹¡ê±°ë¦¬ëŠ” ì• ë‹ˆë©”ì´ì…˜ ì œê±°
                
                // Start ë²„íŠ¼ í™œì„±í™”
                startBtn.disabled = false;
                startBtn.classList.remove('disabled-btn');
                
                // Stop ë²„íŠ¼ ë¹„í™œì„±í™” (ì´ë¯¸ í´ë¦­ ì‹œ ì²˜ë¦¬ë¨)
                stopBtn.disabled = true;
                stopBtn.classList.add('disabled-btn');
            };

            recognition.onerror = (event) => {
                console.error('Recognition error:', event.error);
                status.textContent = 'ì˜¤ë¥˜: ' + event.error;
                isRecognizing = false;
                status.classList.remove('status-blinking'); // ê¹œë¹¡ê±°ë¦¬ëŠ” ì• ë‹ˆë©”ì´ì…˜ ì œê±°
                
                // Start ë²„íŠ¼ í™œì„±í™”
                startBtn.disabled = false;
                startBtn.classList.remove('disabled-btn');
                
                // Stop ë²„íŠ¼ ë¹„í™œì„±í™”
                stopBtn.disabled = true;
                stopBtn.classList.add('disabled-btn');
            };

            recognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';

                // ëª¨ë“  ê²°ê³¼ ì²˜ë¦¬
                for (let i = 0; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    const confidence = event.results[i][0].confidence;
                    const isFinal = event.results[i].isFinal;

                    // console.log(`Result ${i}: "${transcript}" (final: ${isFinal}, confidence: ${confidence})`);

                    if (isFinal) {
                        finalTranscript = transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // ìµœì¢… ê²°ê³¼ í‘œì‹œ (ì¤‘ë³µ ë°©ì§€)
                if (finalTranscript) {
                    const trimmedText = finalTranscript.trim();
                    const lastTrimmedText = lastFinalText.trim();
                    
                    // ì´ì „ ë¬¸ì¥ê³¼ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ ì¶”ê°€
                    if (trimmedText && trimmedText !== lastTrimmedText) {

                        // ê²°ê³¼ ì•„ì´í…œ ì»¨í…Œì´ë„ˆ ìƒì„±
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'result-item';
                        
                        // í…ìŠ¤íŠ¸ ì˜ì—­ ìƒì„±
                        const textSpan = document.createElement('span');
                        textSpan.className = 'result-text';
                        textSpan.textContent = trimmedText;
                        
                        // ë³µì‚¬ ë²„íŠ¼ ìƒì„±
                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'copy-btn';
                        copyBtn.textContent = 'ë³µì‚¬';
                        copyBtn.onclick = () => {
                            navigator.clipboard.writeText(trimmedText).then(() => {
                                copyBtn.textContent = 'ì™„ë£Œ!';
                                setTimeout(() => {
                                    copyBtn.textContent = 'ë³µì‚¬';
                                }, 1000);
                            }).catch(err => {
                                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                                copyBtn.textContent = 'ì‹¤íŒ¨';
                                setTimeout(() => {
                                    copyBtn.textContent = 'ë³µì‚¬';
                                }, 1000);
                            });
                        };
                        
                        // ì»¨í…Œì´ë„ˆì— ì¶”ê°€
                        resultDiv.appendChild(textSpan);
                        resultDiv.appendChild(copyBtn);
                        
                        finalResults.appendChild(resultDiv);
                        finalResults.scrollTop = finalResults.scrollHeight;
                        
                        // ë§ˆì§€ë§‰ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                        lastFinalText = trimmedText;
                    }
                }

                // ì„ì‹œ ê²°ê³¼ í‘œì‹œ
                if (interimTranscript) {
                    interimResults.textContent = 'ì¸ì‹ ì¤‘: ' + interimTranscript;
                } else {
                    interimResults.textContent = '';
                }
            };

            // ì´ˆê¸° ìƒíƒœ ì„¤ì • (ìŒì„± ì¸ì‹ì´ ì§€ì›ë˜ëŠ” ê²½ìš°ì—ë§Œ)
            if (recognition) {
                dropdownDebugInfo.textContent = 'ìŒì„± ì¸ì‹ì´ ì§€ì›ë©ë‹ˆë‹¤.';
            }
        });
    </script>
</body>
</html>